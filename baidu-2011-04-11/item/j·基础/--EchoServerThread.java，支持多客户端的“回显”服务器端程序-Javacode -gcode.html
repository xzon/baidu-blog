<html><head><title>/*EchoServerThread.java，支持多客户端的“回显”服务器端程序-Javacode -gcode</title></head><body><div id='tit'>/*EchoServerThread.java，支持多客户端的“回显”服务器端程序-Javacode -gcode</div><div id='cate'>j&middot;基础</div><div id='date'>2007年12月11日 星期二 07:13 P.M.</div><div id='page'>189</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/a973f4d32248fadca8ec9a77.html'>http://hi.baidu.com/hxzon/blog/item/a973f4d32248fadca8ec9a77.html</a><div id='cnt'><div>
 <font size="3">/*EchoServerThread.java，支持多客户端的“回显”服务器端程序-Javacode -gcode<br /> 我们先启动服务器端，然后启动两个客户端。<br /> 第一个客户端运行结果如下：<br /> socket = Socket[addr=localhost/127.0.0.1,port=9999,localport=1656]<br /> Enter a string, Enter BYE to exit!<br /> abc<br /> Echo 1: abc<br /> cde<br /> Echo 1: cde<br /> efg<br /> Echo 1: efg<br /> hijk<br /> Echo 1: hijk<br /> BYE<br /> 第二个客户端运行结果如下：<br /> socket = Socket[addr=localhost/127.0.0.1,port=9999,localport=1657]<br /> Enter a string, Enter BYE to exit!<br /> ABC<br /> Echo 2: ABC<br /> CDE<br /> Echo 2: CDE<br /> EFG<br /> Echo 2: EFG<br /> BYE<br /> =======================================<br /> 服务器端程序运行结果如下：<br /> Started: ServerSocket[addr=0.0.0.0/0.0.0.0,port=0,localport=9999]<br /> Connection 1 accepted: <br /> Socket[addr=/127.0.0.1,port=1656,localport=9999]<br /> Hello! Enter BYE to exit.<br /> Connection 2 accepted: <br /> Socket[addr=/127.0.0.1,port=1657,localport=9999]<br /> Hello! Enter BYE to exit.<br /> Echo 1: abc<br /> Echo 2: ABC<br /> Echo 2: CDE<br /> Echo 1: cde<br /> Echo 2: EFG<br /> The client 2 entered BYE!<br /> Connection 2 will be closed!<br /> Echo 1: efg<br /> Echo 1: hijk<br /> The client 1 entered BYE!<br /> Connection 1 will be closed!<br /> */</font>
</div> 
<div> 
</div> 
<div>
 <font size="3">import java.io.*;<br /> import java.net.*;</font>
</div> 
<div> 
</div> 
<div>
 <font size="3">public class EchoServerThread{<br /> &nbsp;&nbsp;&nbsp; //服务器端的服务端口。<br /> &nbsp;&nbsp;&nbsp; public static final int SERVERPORT = 9999; <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; public static void main(String[] args ){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try{//已经连接上的客户端的序号。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int number = 1;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //建立服务器端倾听套接字。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ServerSocket s = new ServerSocket(SERVERPORT);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Started: &quot; + s);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while(true){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //等待并接收请求，建立连接套接字。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Socket incoming = s.accept( );<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Connection &quot; + number +&quot; accepted: &quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(incoming);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //启动一个线程来进行服务器端和客户端的数据传输。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //主程序继续监听是否有请求到来。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread t = new EchoThread(incoming, number);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.start();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; number++;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch(IOException e){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.err.println(&quot;IOException&quot;);}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> }//end of EchoServerThread</font>
</div> 
<div> 
</div> 
<div>
 <font size="3">class EchoThread extends Thread{<br /> &nbsp;&nbsp;&nbsp; private Socket s;<br /> &nbsp;&nbsp;&nbsp; int n;<br /> &nbsp;&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; public EchoThread(Socket incoming, int number) {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s = incoming;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n = number;<br /> &nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; public void run(){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try{//新建网络连接的输入流<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BufferedReader in = new BufferedReader(<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new InputStreamReader(s.getInputStream()) );<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //新建网络连接的自动刷新的输出流。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PrintWriter out = new PrintWriter( new BufferedWriter(<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new OutputStreamWriter( s.getOutputStream()) ) , true);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println( &quot;Hello! Enter BYE to exit.&quot; );<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //回显客户端的输入。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (true){ //从网络连接读取一行，即接收客户端的数据。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String line = in.readLine();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //如果接收到的数据为空,则退出循环，关闭连接。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (line == null) break;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{ <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (line.trim().equals(&quot;BYE&quot;)){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;The client &quot; + n + &quot; entered BYE!&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Connection &quot; + n + &quot; will be closed!&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Echo &quot; + n + &quot;: &quot; + line);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //向网络连接输出一行，即向客户端发送数据。<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; out.println(&quot;Echo &quot; + n + &quot;: &quot; + line);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//end while<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s.close();//关闭套接字<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//end try<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (IOException e){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.err.println(&quot;IOException&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp; }//end run<br /> }//end EchoThread</font>
</div> 
<div> 
</div> 
<div> 
</div></div></body></html>