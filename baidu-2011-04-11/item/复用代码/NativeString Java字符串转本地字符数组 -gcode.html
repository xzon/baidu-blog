<html><head><title>NativeString Java字符串转本地字符数组 -gcode</title></head><body><div id='tit'>NativeString Java字符串转本地字符数组 -gcode</div><div id='cate'>复用代码</div><div id='date'>2009年08月26日 星期三 10:01 A.M.</div><div id='page'>35</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/ecd5982f7bebfd311e3089fc.html'>http://hi.baidu.com/hxzon/blog/item/ecd5982f7bebfd311e3089fc.html</a><div id='cnt'><div> 
 <p>NativeString Java字符串转本地字符数组 -gcode</p> 
 <p> </p> 
</div> 
<div> 
</div> 
<div>
 hxzon：chap8官方示例。通过调用String.getBytes()完成本地字符数组。
 <br /> char *JNU_GetStringNativeChars(JNIEnv *env, jstring jstr)
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; jbyteArray bytes = 0;
 <br /> &nbsp;&nbsp;&nbsp; jthrowable exc;
 <br /> &nbsp;&nbsp;&nbsp; char *result = 0;
 <br /> &nbsp;&nbsp;&nbsp; if ((*env)-&gt;EnsureLocalCapacity(env, 2) &lt; 0) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0; /* out of memory error */
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; bytes = (*env)-&gt;CallObjectMethod(env, jstr,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MID_String_getBytes);
 <br /> &nbsp;&nbsp;&nbsp; exc = (*env)-&gt;ExceptionOccurred(env);
 <br /> &nbsp;&nbsp;&nbsp; if (!exc) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jint len = (*env)-&gt;GetArrayLength(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = (char *)malloc(len + 1);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result == 0) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JNU_ThrowByName(env, &quot;java/lang/OutOfMemoryError&quot;,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;GetByteArrayRegion(env, bytes, 0, len,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (jbyte *)result);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result[len] = 0; /* NULL-terminate */
 <br /> &nbsp;&nbsp;&nbsp; } else {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, exc);
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp; return result;
 <br /> }
 <br /> ------------------------
 <br /> package hxzon.jni;
</div> 
<div> 
</div> 
<div>
 class NativeString {
 <br /> &nbsp;&nbsp;&nbsp; private static native String nativeMethod(String s);
 <br /> &nbsp;&nbsp;&nbsp; public static void main(String args[]) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Native method returns: &quot; + nativeMethod(&quot;abcde&quot;));
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; static {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.loadLibrary(&quot;NativeString&quot;);
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> }
 <br /> ------------------------
 <br /> /* DO NOT EDIT THIS FILE - it is machine generated */
 <br /> #include &lt;jni.h&gt;
 <br /> /* Header for class hxzon_jni_NativeString */
</div> 
<div> 
</div> 
<div>
 #ifndef _Included_hxzon_jni_NativeString
 <br /> #define _Included_hxzon_jni_NativeString
 <br /> #ifdef __cplusplus
 <br /> extern &quot;C&quot; {
 <br /> #endif
 <br /> /*
 <br /> * Class:&nbsp;&nbsp;&nbsp;&nbsp; hxzon_jni_NativeString
 <br /> * Method:&nbsp;&nbsp;&nbsp; nativeMethod
 <br /> * Signature: (Ljava/lang/String;)Ljava/lang/String;
 <br /> */
 <br /> JNIEXPORT jstring JNICALL Java_hxzon_jni_NativeString_nativeMethod
 <br /> (JNIEnv *, jclass, jstring);
</div> 
<div> 
</div> 
<div>
 #ifdef __cplusplus
 <br /> }
 <br /> #endif
 <br /> #endif
 <br /> --------------------------
 <br /> #include &lt;jni.h&gt;
 <br /> #include &lt;stdio.h&gt;
 <br /> #include &quot;hxzon_jni_NativeString.h&quot;
</div> 
<div> 
</div> 
<div>
 JavaVM *cached_jvm;
 <br /> jclass Class_C;
 <br /> jmethodID MID_C_g;
</div> 
<div> 
</div> 
<div>
 JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM *jvm, void *reserved)
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; JNIEnv *env;
 <br /> &nbsp;&nbsp;&nbsp; jclass cls;
 <br /> &nbsp;&nbsp;&nbsp; cached_jvm = jvm; /* cache the JavaVM pointer */
 <br /> &nbsp;&nbsp;&nbsp; if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return JNI_ERR;
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; cls = (*env)-&gt;FindClass(env, &quot;java/lang/String&quot;);
 <br /> &nbsp;&nbsp;&nbsp; if (cls == NULL) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return JNI_ERR;
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; /* Use weak global ref to allow C class to be unloaded */
 <br /> &nbsp;&nbsp;&nbsp; Class_C = (*env)-&gt;NewWeakGlobalRef(env, cls);
 <br /> &nbsp;&nbsp;&nbsp; if (Class_C == NULL) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return JNI_ERR;
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; /* Compute and cache the method ID */
 <br /> &nbsp;&nbsp;&nbsp; MID_C_g = (*env)-&gt;GetMethodID(env, cls, &quot;getBytes&quot;, &quot;()[B&quot;);
 <br /> &nbsp;&nbsp;&nbsp; if (MID_C_g == NULL) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return JNI_ERR;
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; return JNI_VERSION_1_2;
 <br /> }
</div> 
<div> 
</div> 
<div>
 JNIEXPORT void JNICALL 
 <br /> JNI_OnUnload(JavaVM *jvm, void *reserved)
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; JNIEnv *env;
 <br /> &nbsp;&nbsp;&nbsp; if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteWeakGlobalRef(env, Class_C);
 <br /> &nbsp;&nbsp;&nbsp; return;
 <br /> }
</div> 
<div> 
</div> 
<div>
 jclass Class_java_lang_String;
 <br /> jmethodID MID_String_init;
 <br /> jmethodID MID_String_getBytes;
</div> 
<div> 
</div> 
<div>
 void initIDs(JNIEnv *env)
 <br /> {
 <br /> Class_java_lang_String = (*env)-&gt;FindClass(env, &quot;java/lang/String&quot;);
 <br /> MID_String_init = (*env)-&gt;GetMethodID(env, Class_java_lang_String,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp; &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);
 <br /> MID_String_getBytes = (*env)-&gt;GetMethodID(env, Class_java_lang_String,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp; &quot;getBytes&quot;, &quot;()[B&quot;);
 <br /> }
</div> 
<div> 
</div> 
<div>
 jstring JNU_NewStringNative(JNIEnv *env, const char *str)
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; jstring result;
 <br /> &nbsp;&nbsp;&nbsp; jbyteArray bytes = 0;
 <br /> &nbsp;&nbsp;&nbsp; int len;
 <br /> &nbsp;&nbsp;&nbsp; if ((*env)-&gt;EnsureLocalCapacity(env, 2) &lt; 0) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return NULL; /* out of memory error */
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; len = strlen(str);
 <br /> &nbsp;&nbsp;&nbsp; bytes = (*env)-&gt;NewByteArray(env, len);
 <br /> &nbsp;&nbsp;&nbsp; if (bytes != NULL) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;SetByteArrayRegion(env, bytes, 0, len,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (jbyte *)str);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = (*env)-&gt;NewObject(env, Class_java_lang_String,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MID_String_init, bytes);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;
 <br /> &nbsp;&nbsp;&nbsp; } /* else fall through */
 <br /> &nbsp;&nbsp;&nbsp; return NULL;
 <br /> }
</div> 
<div> 
</div> 
<div>
 char *JNU_GetStringNativeChars(JNIEnv *env, jstring jstr)
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; jbyteArray bytes = 0;
 <br /> &nbsp;&nbsp;&nbsp; jthrowable exc;
 <br /> &nbsp;&nbsp;&nbsp; char *result = 0;
 <br /> &nbsp;&nbsp;&nbsp; if ((*env)-&gt;EnsureLocalCapacity(env, 2) &lt; 0) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0; /* out of memory error */
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; bytes = (*env)-&gt;CallObjectMethod(env, jstr,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MID_String_getBytes);
 <br /> &nbsp;&nbsp;&nbsp; exc = (*env)-&gt;ExceptionOccurred(env);
 <br /> &nbsp;&nbsp;&nbsp; if (!exc) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jint len = (*env)-&gt;GetArrayLength(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = (char *)malloc(len + 1);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result == 0) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JNU_ThrowByName(env, &quot;java/lang/OutOfMemoryError&quot;,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;GetByteArrayRegion(env, bytes, 0, len,
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (jbyte *)result);
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result[len] = 0; /* NULL-terminate */
 <br /> &nbsp;&nbsp;&nbsp; } else {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, exc);
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, bytes);
 <br /> &nbsp;&nbsp;&nbsp; return result;
 <br /> }
</div> 
<div> 
</div> 
<div>
 JNIEXPORT jstring JNICALL Java_hxzon_jni_NativeString_nativeMethod
 <br /> (JNIEnv *env, jclass cls, jstring jstr)
 <br /> {
 <br /> initIDs(env);
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; char *str = JNU_GetStringNativeChars(env, jstr);
 <br /> &nbsp;&nbsp;&nbsp; return JNU_NewStringNative(env, str);
 <br /> }
 <br /> }
 <br /> ------------------------------
 <br /> ThrowByName.c
</div> 
<div> 
</div> 
<div>
 #include &lt;jni.h&gt;
</div> 
<div> 
</div> 
<div>
 void
 <br /> JNU_ThrowByName(JNIEnv *env, const char *name, const char *msg)
 <br /> {
 <br /> &nbsp;&nbsp;&nbsp; jclass cls = (*env)-&gt;FindClass(env, name);
 <br /> &nbsp;&nbsp;&nbsp; /* If cls is NULL, an exception has already been thrown */
 <br /> &nbsp;&nbsp;&nbsp; if (cls != NULL) {
 <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*env)-&gt;ThrowNew(env, cls, msg);
 <br /> &nbsp;&nbsp;&nbsp; }
 <br /> &nbsp;&nbsp;&nbsp; /* free the local ref */
 <br /> &nbsp;&nbsp;&nbsp; (*env)-&gt;DeleteLocalRef(env, cls);
 <br /> }
 <br /> =============================
 <br /> D:\workspace\HxzonUtils\bin&gt;
 <br /> cl -I&quot;%java_home%\include&quot; -I&quot;%java_home%\include\win32&quot; -LD hxzon_jni_NativeString.c ThrowByName.c -FeNativeString.dll
</div></div></body></html>