<html><head><title>Eclipse的内存优化与内存不足问题</title></head><body><div id='tit'>Eclipse的内存优化与内存不足问题</div><div id='cate'>小技巧</div><div id='date'>2009年09月05日 星期六 00:09 A.M.</div><div id='page'>32</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/5e60d7c8a47f391e7e3e6fc9.html'>http://hi.baidu.com/hxzon/blog/item/5e60d7c8a47f391e7e3e6fc9.html</a><div id='cnt'><p>Eclipse的内存优化与内存不足问题</p> 
<div class="cnt"> 
 <p>最近我的Eclipse总是崩溃 ，慢的要命，1G的内存好像也没用完阿，气死我了， 错误提示：</p> 
 <p>MyEclipse has detected that less than 5% of the 64MB of Perm <br /> Gen (Non-heap memory) space remains. It is strongly recommended<br /> that you exit and restart MyEclipse with new virtual machine memory<br /> paramters to increase this memory.&nbsp;&nbsp; Failure to do so can result in<br /> data loss. The recommended Eclipse memory parameters are: <br /> eclipse.exe -vmargs -Xms128M -Xmx512M -XX:PermSize=64M -XX:MaxPermSize=128M</p> 
 <p>eclipse根目录下面的 eclipse.ini 配置 从网上搜了些资料</p> 
 <p>-vmargs：说明后面是VM的参数<br /> -Xms128m：虚拟机占用系统的最小内存<br /> -Xmx512m：虚拟机占用系统的最大内存的5%为25.6M，理论上要求-Xmx的数值与-XX:MaxPermSize<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 必须大于25.6M<br /> -XX:PermSize：最小堆大小。一般报内存不足时,都是说这个太小,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 堆空间剩余小于5%就会警告,建议把这个稍微设<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 大一点,不过要视自己机器内存大小来设置<br /> -XX:MaxPermSize：最大堆大小。这个也适当大些</p> 
 <p>把里面的参数改为<br /> -vmargs&nbsp;&nbsp;<br /> -Xms128M&nbsp;&nbsp;<br /> -Xmx512M&nbsp;&nbsp;<br /> -XX:PermSize=128M&nbsp;&nbsp;<br /> -XX:MaxPermSize=256M<br /> 问题解决！</p> 
 <p>从网上的资料看PermSize大一点肯定更好，而且最好是设置PermSize和MaxPermSize一样大。理由如下： <br /> PermSize 和MaxPermSize如果设置为相同还可以在一定程度上提高性能，因为，PermSize在不断的变化中会需要转移其中的数据。如果固定了以后，则可以减少每次扩大PermSize带来的性能损失。</p> 
 <p>1、PermGen space简介 <br /> <br /> PermGen space的全称是Permanent Generation space，是指内存的永久保存区域OutOfMemoryError: PermGen space从表面上看就是内存益出，解决方法也一定是加大内存。 <br /> <br /> 说说为什么会内存益出： <br /> （1）这一部分用于存放Class和Meta的信息，Class在被 Load的时候被放入PermGen space区域，它和和存放Instance的Heap区域不同。 <br /> （2） GC(Garbage Collection)不会在主程序运行期对PermGen space进行清理，所以如果你的APP会LOAD很多CLASS 的话,就很可能出现PermGen space错误。这种错误常见在web服务器对JSP进行pre compile的时候。 <br /> <br /> 如果你的WEB APP下都用了大量的第三方jar，其大小超过了jvm默认的大小(4M)那么就会产生此错误信息了。</p> 
 <p><strong>解决方法： 手动设置MaxPermSize大小 <br /> </strong> <br /> 修改TOMCAT_HOME/bin/catalina.bat，在echo &quot;Using CATALINA_BASE: $CATALINA_BASE&quot;上面加入以下行： <br /> JAVA_OPTS=&quot;-server -XX:PermSize=64M -XX:MaxPermSize=128m <br /> <strong>建议：将相同的第三方jar文件移置到tomcat/shared/lib目录下，这样可以减少jar 文档重复占用内存</strong></p> 
 <p><strong>1。参数的含义</strong></p> 
 <p>-vmargs -Xms128M -Xmx512M -XX:PermSize=64M -XX:MaxPermSize=128M</p> 
 <p>参数中-vmargs的意思是设置JVM参数，所以后面的其实都是JVM的参数了，我们首先了解一下JVM内存管理的机制，然后再解释每个参数代表的含义。<br /> 堆(Heap)和非堆(Non-heap)内存<br /> 按照官方的说法：“Java 虚拟机具有一个堆，堆是运行时数据区域，所有类实例和数组的内存均从此处分配。堆是在 Java 虚拟机启动时创建的。”“在JVM中堆之外的内存称为非堆内存(Non-heap memory)”。可以看出JVM主要管理两种类型的内存：堆和非堆。简单来说堆就是Java代码可及的内存，是留给开发人员使用的；非堆就是JVM留给自己用的，所以方法区、JVM内部处理或优化所需的内存(如JIT编译后的代码缓存)、每个类结构(如运行时常数池、字段和方法数据)以及方法和构造方法的代码都在非堆内存中。 <br /> 堆内存分配<br /> <strong>JVM初始分配的内存由-Xms指定</strong>，默认是物理内存的1/64；<strong>JVM最大分配的内存由-Xmx指定</strong>，默认是物理内存的1/4。默认空余堆内存小于40%时，JVM就会增大堆直到-Xmx的最大限制；空余堆内存大于70%时，JVM会减少堆直到-Xms的最小限制。因此服务器一般设置-Xms、-Xmx相等以避免在每次GC 后调整堆的大小。 <br /> 非堆内存分配<br /> <strong>JVM使用-XX:PermSize设置非堆内存初始值</strong>，默认是物理内存的1/64；<strong>由XX:MaxPermSize设置最大非堆内存的大小</strong>，默认是物理内存的1/4。 <br /> JVM内存限制(最大值)<br /> 首先JVM内存限制于实际的最大物理内存，假设物理内存无限大的话，JVM内存的最大值跟操作系统有很大的关系。简单的说就32位处理器虽然可控内存空间有4GB,但是具体的操作系统会给一个限制，这个限制一般是2GB-3GB（一般来说Windows系统下为1.5G-2G，Linux系统下为2G- 3G），而64bit以上的处理器就不会有限制了。</p> 
 <p><strong>2. 为什么有的机器我将-Xmx和-XX:MaxPermSize都设置为512M之后Eclipse可以启动，而有些机器无法启动？</strong></p> 
 <p>通过上面对JVM内存管理的介绍我们已经了解到JVM内存包含两种：堆内存和非堆内存，另外JVM最大内存首先取决于实际的物理内存和操作系统。所以说设置VM参数导致程序无法启动主要有以下几种原因：<br /> 1) 参数中-Xms的值大于-Xmx，或者-XX:PermSize的值大于-XX:MaxPermSize；<br /> 2) -Xmx的值和-XX:MaxPermSize的总和超过了JVM内存的最大限制，比如当前操作系统最大内存限制，或者实际的物理内存等等。说到实际物理内存这里需要说明一点的是，如果你的内存是1024MB，但实际系统中用到的并不可能是1024MB，因为有一部分被硬件占用了。</p> 
 <p><strong>3. 为何将上面的参数写入到eclipse.ini文件Eclipse没有执行对应的设置？</strong><br /> 那为什么同样的参数在快捷方式或者命令行中有效而在eclipse.ini文件中是无效的呢？这是因为我们没有遵守eclipse.ini文件的设置规则：<br /> 参数形如“项 值”这种形式，中间有空格的需要换行书写，如果值中有空格的需要用双引号包括起来。比如我们使用-vm C:\Java\jre1.6.0\bin\javaw.exe参数设置虚拟机，在eclipse.ini文件中要写成这样：<br /> -vm <br /> C:\Java\jre1.6.0\bin\javaw.exe <br /> 按照上面所说的，最后参数在eclipse.ini中可以写成这个样子：<br /> -vmargs <br /> -Xms128M <br /> -Xmx512M <br /> -XX:PermSize=64M <br /> -XX:MaxPermSize=128M <br /> 实际运行的结果可以通过Eclipse中“Help”-“About Eclipse SDK”窗口里面的“Configuration Details”按钮进行查看。<br /> 另外需要说明的是，Eclipse压缩包中自带的eclipse.ini文件内容是这样的：<br /> -showsplash <br /> org.eclipse.platform <br /> --launcher.XXMaxPermSize <br /> 256m <br /> -vmargs <br /> -Xms40m <br /> -Xmx256m <br /> 其中<strong>–launcher.XXMaxPermSize</strong>（注意最前面是两个连接线）跟<strong>-XX:MaxPermSize</strong>参数的含义基本是一样的，我觉得唯一的区别就是前者是eclipse.exe启动的时候设置的参数，而后者是eclipse所使用的JVM中的参数。其实二者设置一个就可以了，所以这里可以把–launcher.XXMaxPermSize和下一行使用#注释掉。</p> 
 <p>3. 其他的启动参数。 如果你有一个双核的CPU，也许可以尝试这个参数:</p> 
 <p><code><font face="新宋体">-XX:+UseParallelGC</font></code></p> 
 <p>让GC可以更快的执行。（只是JDK 5里对GC新增加的参数）</p> 
 <p> </p> 
 <p><strong>补充：</strong></p> 
 <p>可以在myelipse里选中相应的服务器比如<strong>tomcat5</strong>，展开里面的JDK子项页面，来增加服务器启动的JVM参数设置：</p> 
 <p>-Xms128m <br /> -Xmx256m <br /> -XX:PermSize=128M <br /> -XX:MaxNewSize=256m <br /> -XX:MaxPermSize=256m</p> 
</div></div></body></html>