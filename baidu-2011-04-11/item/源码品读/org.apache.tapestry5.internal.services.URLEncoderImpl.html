<html><head><title>org.apache.tapestry5.internal.services.URLEncoderImpl</title></head><body><div id='tit'>org.apache.tapestry5.internal.services.URLEncoderImpl</div><div id='cate'>源码品读</div><div id='date'>2010年08月24日 星期二 11:09 A.M.</div><div id='page'>10</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/97ca32a8957386bfca130c01.html'>http://hi.baidu.com/hxzon/blog/item/97ca32a8957386bfca130c01.html</a><div id='cnt'><p>org.apache.tapestry5.internal.services.URLEncoderImpl</p> 
<p>tapestry源码品读 代码复用</p> 
<pre>package org.apache.tapestry5.internal.services;<br /><br />import org.apache.tapestry5.ioc.internal.util.Defense;<br />import org.apache.tapestry5.services.URLEncoder;<br /><br />import java.util.BitSet;<br /><br />public class URLEncoderImpl implements URLEncoder<br />{<br />    static final String ENCODED_NULL = &quot;$N&quot;;<br />    static final String ENCODED_BLANK = &quot;$B&quot;;<br /><br />    /**<br />     * Bit set indicating which character are safe to pass through (when encoding or decoding) as-is.  All other<br />     * characters are encoded as a kind of unicode escape.<br />     */<br />    private final BitSet safe = new BitSet(128);<br /><br />    {<br />        markSafe(&quot;abcdefghijklmnopqrstuvwxyz&quot;);<br />        markSafe(&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;);<br />        markSafe(&quot;01234567890-_.:&quot;);<br />    }<br /><br />    private void markSafe(String s)<br />    {<br />        for (char ch : s.toCharArray())<br />        {<br />            safe.set((int) ch);<br />        }<br />    }<br /><br /><br />    public String encode(String input)<br />    {<br />        if (input == null) return ENCODED_NULL;<br /><br />        if (input.equals(&quot;&quot;)) return ENCODED_BLANK;<br /><br />        boolean dirty = false;<br /><br />        int length = input.length();<br /><br />        StringBuilder output = new StringBuilder(length * 2);<br /><br />        for (int i = 0; i &lt; length; i++)<br />        {<br />            char ch = input.charAt(i);<br /><br />            if (ch == '$')<br />            {<br />                output.append(&quot;$$&quot;);<br />                dirty = true;<br />                continue;<br />            }<br /><br />            int chAsInt = (int) ch;<br /><br />            if (safe.get(chAsInt))<br />            {<br />                output.append(ch);<br />                continue;<br />            }<br /><br />            output.append(String.format(&quot;$%04x&quot;, chAsInt));<br />            dirty = true;<br />        }<br /><br />        return dirty ? output.toString() : input;<br />    }<br /><br />    public String decode(String input)<br />    {<br />        Defense.notNull(input, &quot;input&quot;);<br /><br />        if (input.equals(ENCODED_NULL)) return null;<br /><br />        if (input.equals(ENCODED_BLANK)) return &quot;&quot;;<br /><br />        boolean dirty = false;<br /><br />        int length = input.length();<br /><br />        StringBuilder output = new StringBuilder(length * 2);<br /><br />        for (int i = 0; i &lt; length; i++)<br />        {<br />            char ch = input.charAt(i);<br /><br />            if (ch == '$')<br />            {<br />                dirty = true;<br /><br />                if (i + 1 &lt; length &amp;&amp; input.charAt(i + 1) == '$')<br />                {<br />                    output.append('$');<br />                    i++;<br /><br />                    dirty = true;<br />                    continue;<br />                }<br /><br />                if (i + 4 &lt; length)<br />                {<br />                    String hex = input.substring(i + 1, i + 5);<br /><br />                    try<br />                    {<br />                        int unicode = Integer.parseInt(hex, 16);<br /><br />                        output.append((char) unicode);<br />                        i += 4;<br />                        dirty = true;<br />                        continue;<br />                    }<br />                    catch (NumberFormatException ex)<br />                    {<br />                        // Ignore.<br />                    }<br />                }<br /><br />                throw new IllegalArgumentException(String.format(<br />                        &quot;Input string '%s' is not valid; the '$' character at position %d should be followed by another '$' or a four digit hex number (a unicode value).&quot;,<br />                        input, i + 1));<br />            }<br /><br />            if (!safe.get((int) ch))<br />            {<br />                throw new IllegalArgumentException(<br />                        String.format(&quot;Input string '%s' is not valid; the character '%s' at position %d is not valid.&quot;,<br />                                      input, ch, i + 1));<br />            }<br /><br />            output.append(ch);<br />        }<br /><br />        return dirty ? output.toString() : input;<br />    }<br />}</pre> 
<p> </p> 
<p> </p></div></body></html>