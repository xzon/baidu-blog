<html><head><title><div class="tit">
  New URL Rewriting API
</div></title></head><body><div id='tit'>New URL Rewriting API</div><div id='cate'>j&middot;web</div><div id='date'>2010年11月23日 星期二 11:32 A.M.</div><div id='page'>4</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/59f2d709a40a5492d0581beb.html'>http://hi.baidu.com/hxzon/blog/item/59f2d709a40a5492d0581beb.html</a><div id='cnt'><h2 class="titlePost">New URL Rewriting API</h2> 
<p><a href="http://blog.tapestry5.de/index.php/2010/09/06/new-url-rewriting-api/">http://blog.tapestry5.de/index.php/2010/09/06/new-url-rewriting-api/</a></p> 
<p> </p> 
<p>Since 5.1.0.1, Tapestry has basic support for URL rewriting based on the <em>URLRewriter</em> service. In 5.2.0 this service has been deprecated in favour of <em>LinkTransformer</em> service. The new service is actually a facade around <em>ComponentEventLinkTransformer</em> and <em>PageRenderLinkTransformer</em> services.</p> 
<p>The <em>PageRenderLinkTransformer</em> service is responsible for the transformation of the page render requests. The implementation of the service is a chain of <em>PageRenderLinkTransformer</em>.</p> 
<p>The <em>ComponentEventLinkTransformer</em> service allows a selective replacement of the default links used to represent a component event request. The implementation of the service is a chain of <em>ComponentEventLinkTransformer</em>. Now let’s see some examples.</p> 
<h2>Rewriting incoming URLs</h2> 
<p>Imagine you decided to migrate your existing application to Tapestry. Let’s say you are moving from JavaServer Faces. Because the navigation mechanisms in Tapestry and JSF are different, the URLs of your application will change in a incompatible way. This might annoy some of your users who bookmarked the URLs. After the migration these URLs will not work any more. In order to avoid it, you might rewrite all the incoming URLs that start with <em>/jsf</em>.</p> 
<p>When processing an incoming requests Tapestry tries to determine if the request is a page render request. If so, Tapestry creates an instance of <em>PageRenderRequestParameters</em> which represents a page and its activation context. The created instance of <em>PageRenderRequestParameters</em> is then used by the <em>PageRenderRequestHandler</em> service to handle a page render request by activating and then rendering the page.</p> 
<p>You can take over the task of creation of <em>PageRenderRequestParameters</em> by contributing a <em>PageRenderLinkTransformer</em>. The following listing shows how to accomplish this. When Tapestry attempts to decode the page render request, it will invoke the <em>decodePageRenderRequest()</em> method of <em>JsfLinkTransformer</em>. Inside this method we check if the request path is for a JSF page. If so, an instance of <em>PageRenderRequestParameters</em> representing the <em>Index</em> page with an empty activation context is returned. This will cause the rendering of the <em>Index </em>page when the <em>/jsf/home.xhtml</em> path is requested.</p> 
<p>If the incoming request was not identified as a JSF request, a <em>null</em> value is returned. In this case the default logic for decoding the page render request will be executed.</p> 
<pre>public class JsfLinkTransformer implements PageRenderLinkTransformer {<br /><br />   public PageRenderRequestParameters decodePageRenderRequest(<br />                  Request request) {<br />      String path = request.getPath();<br /><br />      if (path.startsWith(&quot;/jsf/home.xhtml&quot;)) {<br />         return new PageRenderRequestParameters(<br />            Index.class.getSimpleName(),<br />            new EmptyEventContext(),<br />            false);<br />      }<br /><br />      return null;<br />    }<br /><br />   public Link transformPageRenderLink(<br />         Link defaultLink,<br />         PageRenderRequestParameters parameters) {<br />      return defaultLink;<br />   }<br />}</pre> 
<p>The class <em>EmptyEventContext</em> represents an empty activation context as shown in following example.</p> 
<pre>public class EmptyEventContext implements EventContext {<br /><br />   public int getCount() {<br />      return 0;<br />   }<br /><br />   public  T get(final Class desiredType, final int index) {<br />      return null;<br />   }<br /><br />   public String[] toStrings() {<br />      return new String[0];<br />   }<br />}</pre> 
<p>The next listing shows how to contribute an <em>JsfLinkTransformer</em> to the configuration of the <em>PageRenderLinkTransformer</em> service.</p> 
<pre>public class AppModule {<br /><br />   @Contribute(PageRenderLinkTransformer.class)<br />   @Primary<br />   public static void provideURLRewriting(<br />      OrderedConfiguration&lt;PageRenderLinkTransformer&gt;<br /> configuration) {<br /><br />      configuration.addInstance(<br />         &quot;Faces&quot;, FacesLinkTransformer.class);<br />   }<br />}</pre> 
<h2>Rewriting URLs within an Application</h2> 
<p>Imagine you want to deprecate a page inside your application in favour of a new page. Because some of your users might have bookmarked the old page you decided to keep it for a while. The URL of the page should still be accessible but all the links inside the application need to be updated. You can either go through all pages of your application to update the <em>page</em> parameter of the <em>PageLink</em> component or you can make a global replacement by contributing to the configuration of the <em>PageRenderLinkTransformer</em> service.</p> 
<p>After creating a <em>Link</em> that encapsulates a page render request, Tapestry passes that <em>Link</em> through the <em>PageRenderLinkTransformer</em> chain of command. By contributing your own <em>PageRenderLinkTransformer</em> you can replace a passed link by another one. The following listing shows how to replace a link to <em>MyPage</em> by a link to <em>AnotherPage</em> globally. Inside the <em>transformPageRenderLink()</em> method the base path of the passed link is examined to identify the target page. If the <em>Link</em> represents a URL to <em>MyPage</em>, then a <em>Link</em> to <em>AnotherPage</em> is created and returned. Returning the original <em>Link</em> means that no transformation is required.</p> 
<pre>public class DeprecatePageLinkTransformer implements PageRenderLinkTransformer {<br /><br />   @Inject<br />   private PageRenderLinkSource pageRenderLinkSource;<br /><br />   public PageRenderRequestParameters decodePageRenderRequest(<br />                  Request request) {<br />      return null;<br />   }<br /><br />   public Link transformPageRenderLink(<br />         Link defaultLink,<br />         PageRenderRequestParameters parameters) {<br /><br />      if (defaultLink.getBasePath().contains(&quot;/mypage&quot;)) {<br />         return this.pageRenderLinkSource<br />               .createPageRenderLink(AnotherPage.class);<br />      }<br /><br />      return defaultLink;<br />   }<br />}</pre> 
<p>The contribution in the following listing will cause that all the <em>PageLink</em> linking to <em>MyPage</em> will render a page link to <em>AnotherPage</em> event though the <em>page</em> parameter is set to <em>MyPage</em>.</p> 
<pre>public class AppModule {<br /><br />   @Contribute(PageRenderLinkTransformer.class)<br />   @Primary<br />   public static void provideURLRewriting(<br />      OrderedConfiguration&lt;PageRenderLinkTransformer&gt;<br /> configuration) {<br /><br />      configuration.addInstance(<br />         &quot;DeprecatePageLink&quot;,<br />         DeprecatePageLinkTransformer.class);<br />   }<br />}</pre> 
<h2>Rewriting Component Event URLs</h2> 
<p>Finally, the replacement of the default links used to represent a component event request is accomplished by the <em>ComponentEventLinkTransformer</em> service. This transformer follows the same pattern as <em>PageRenderLinkTransformer</em>.</p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p></div></body></html>