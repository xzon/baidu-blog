<html><head><title><div class="tit">
  一个通用的MYSQL数据库操作类
</div></title></head><body><div id='tit'>一个通用的MYSQL数据库操作类</div><div id='cate'>代码备份</div><div id='date'>2008年03月09日 星期日 10:28 P.M.</div><div id='page'>165</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/db9255431bb70e159313c691.html'>http://hi.baidu.com/hxzon/blog/item/db9255431bb70e159313c691.html</a><div id='cnt'><p>一个通用的MYSQL数据库操作类</p> 
<p><font color="#008080" size="3"><strong>&lt;?php<br /> class dbclass {<br /> var $querynum = 0;<br /> &nbsp;&nbsp;&nbsp;&nbsp; var $db_die&nbsp;&nbsp;&nbsp; = 0;<br /> function connect($dbhost, $dbuser, $dbpassword, $dbname, $pconnect = 0) {<br /> &nbsp;&nbsp; global $timpstamp,$querytime;<br /> &nbsp;&nbsp; if($GLOBALS['set_debug']) {<br /> &nbsp;&nbsp;&nbsp; $pageendtime=microtime();<br /> &nbsp;&nbsp;&nbsp; $starttime=explode(&quot; &quot;,$timpstamp);<br /> &nbsp;&nbsp;&nbsp; $endtime=explode(&quot; &quot;,$pageendtime);<br /> &nbsp;&nbsp;&nbsp; $beforetime=$endtime[0]-$starttime[0]+$endtime[1]-$starttime[1];<br /> &nbsp;&nbsp; }<br /> &nbsp;&nbsp; if($pconnect) {<br /> &nbsp;&nbsp;&nbsp; if(</strong></font><a href="mailto:!@mysql_pconnect($dbhost"><font color="#008080" size="3"><strong>!@mysql_pconnect($dbhost</strong></font></a><font color="#008080" size="3"><strong>, $dbuser, $dbpassword)) {<br /> &nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;occur_error(&quot;MySQL 数据库无法连接，请检查服务器或程序设置&quot;);<br /> &nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp; } else {<br /> &nbsp;&nbsp;&nbsp; if(</strong></font><a href="mailto:!@mysql_connect($dbhost"><font color="#008080" size="3"><strong>!@mysql_connect($dbhost</strong></font></a><font color="#008080" size="3"><strong>, $dbuser, $dbpassword)) {<br /> &nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;occur_error(&quot;MySQL 数据库无法连接，请检查服务器或程序设置&quot;);<br /> &nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp; }<br /> &nbsp;&nbsp; if($GLOBALS['set_debug']) {<br /> &nbsp;&nbsp;&nbsp; $pageendtime=microtime();<br /> &nbsp;&nbsp;&nbsp; $starttime=explode(&quot; &quot;,$timpstamp);<br /> &nbsp;&nbsp;&nbsp; $endtime=explode(&quot; &quot;,$pageendtime);</strong></font></p> 
<p><font color="#008080" size="3"><strong>&nbsp;&nbsp;&nbsp; $aftertime=$endtime[0]-$starttime[0]+$endtime[1]-$starttime[1];<br /> &nbsp;&nbsp;&nbsp; $querytime+=$aftertime-$beforetime;<br /> &nbsp;&nbsp; }<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function select_db($dbname) {<br /> &nbsp;&nbsp; return mysql_select_db($dbname);<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function fetch_array($query, $result_type = MYSQL_ASSOC) {<br /> &nbsp;&nbsp; $query = mysql_fetch_array($query, $result_type);<br /> &nbsp;&nbsp; return $query;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function query($sql, $silence = 0) {<br /> &nbsp;&nbsp; global $timpstamp,$querytime,$sql_s;<br /> &nbsp;&nbsp; if($GLOBALS['set_debug']) {<br /> &nbsp;&nbsp;&nbsp; $pageendtime=microtime();<br /> &nbsp;&nbsp;&nbsp; $starttime=explode(&quot; &quot;,$timpstamp);<br /> &nbsp;&nbsp;&nbsp; $endtime=explode(&quot; &quot;,$pageendtime);<br /> &nbsp;&nbsp;&nbsp; $beforetime=$endtime[0]-$starttime[0]+$endtime[1]-$starttime[1];<br /> &nbsp;&nbsp; }<br /> $sql_s .= $sql.'&lt;br&gt;';<br /> &nbsp;&nbsp; $query = mysql_query($sql);<br /> &nbsp;&nbsp; if(!$query &amp;&amp; !$silence) {<br /> &nbsp;&nbsp;&nbsp; if(mysql_errno() == 1016) {<br /> &nbsp;&nbsp;&nbsp;&nbsp; mysql_query(&quot;REPAIR TABLE stat_mem&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; mysql_query(&quot;REPAIR TABLE members&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; mysql_query(&quot;REPAIR TABLE post&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; mysql_query(&quot;REPAIR TABLE thread&quot;);<br /> &nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp; $query = mysql_query($sql);<br /> &nbsp;&nbsp;&nbsp; if(!$query &amp;&amp; !$silence) {<br /> &nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;occur_error(&quot;MySQL Query 错误&quot;, $sql);<br /> &nbsp;&nbsp;&nbsp; }</strong></font></p> 
<p><font color="#008080" size="3"><strong>&nbsp;&nbsp; }<br /> &nbsp;&nbsp; $this-&gt;querynum++;</strong></font></p> 
<p><br /> <font color="#008080" size="3"><strong>&nbsp;&nbsp; if($GLOBALS['set_debug']) {<br /> &nbsp;&nbsp;&nbsp; $pageendtime=microtime();<br /> &nbsp;&nbsp;&nbsp; $starttime=explode(&quot; &quot;,$timpstamp);<br /> &nbsp;&nbsp;&nbsp; $endtime=explode(&quot; &quot;,$pageendtime);</strong></font></p> 
<p><font color="#008080" size="3"><strong>&nbsp;&nbsp;&nbsp; $aftertime=$endtime[0]-$starttime[0]+$endtime[1]-$starttime[1];<br /> &nbsp;&nbsp;&nbsp; $querytime+=$aftertime-$beforetime;<br /> &nbsp;&nbsp; }</strong></font></p> 
<p><font color="#008080" size="3"><strong>&nbsp;&nbsp; return $query;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function query_fetch($sql) {<br /> &nbsp;&nbsp; $query = $this-&gt;query($sql);<br /> &nbsp;&nbsp; $returnarray=$this-&gt;fetch_array($query);<br /> &nbsp;&nbsp; $this-&gt;free_result($query);<br /> &nbsp;&nbsp; return $returnarray;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function affected_rows() {<br /> &nbsp;&nbsp; return mysql_affected_rows();<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function result($query, $row) {<br /> &nbsp;&nbsp; $query = @mysql_result($query, $row);<br /> &nbsp;&nbsp; return $query;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function num_rows($query) {<br /> &nbsp;&nbsp; $query = mysql_num_rows($query);<br /> &nbsp;&nbsp; return $query;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function num_fields($query) {<br /> &nbsp;&nbsp; return mysql_num_fields($query);<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function free_result($query) {<br /> &nbsp;&nbsp; return mysql_free_result($query);<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function insert_id() {<br /> &nbsp;&nbsp; $id = mysql_insert_id();<br /> &nbsp;&nbsp; return $id;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function fetch_row($query) {<br /> &nbsp;&nbsp; $query = mysql_fetch_row($query);<br /> &nbsp;&nbsp; return $query;<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>function close() {<br /> &nbsp;&nbsp; return mysql_close();<br /> }<br /> function error() {<br /> &nbsp;&nbsp; return mysql_error();<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>&nbsp;&nbsp;&nbsp;&nbsp; function occur_error($error='',$sql='') {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($this-&gt;db_die == 1) {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;error = mysql_error();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return TRUE;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp; $sql_error .= &quot;&quot;;<br /> &nbsp;&nbsp; $sql_error .= &quot;错误提示:&nbsp;&nbsp; &quot;.mysql_error().&quot;\n&quot;;<br /> &nbsp;&nbsp; $sql_error .= &quot;错误代号:&nbsp;&nbsp; &quot;.mysql_errno().&quot;\n&quot;;<br /> &nbsp;&nbsp; $sql_error .= &quot;发生时间:&nbsp;&nbsp; &quot;.date(&quot;Y-m-d H:i:s&quot;).&quot;\n&quot;;<br /> &nbsp;&nbsp; $sql?($sql_error .= &quot;错误语句:&nbsp;&nbsp;&nbsp; $sql&quot;):NULL;<br /> &nbsp;&nbsp; $sql_error = nl2br($sql_error);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $errorout = &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;数据库发生错误&lt;/title&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;style&gt;P,BODY{ font-family:宋体,arial,sans-serif; font-size:12px; }&lt;/style&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp; &lt;/head&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp; &lt;body&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;nbsp;&lt;br&gt;&lt;br&gt;&lt;blockquote&gt;数据库发生错误 如不能解决请与&lt;a href=\&quot;</strong></font><a href="http://www.1119.net/"><font color="#008080" size="3"><strong>http://www.1119.net\</strong></font></a><font color="#008080" size="3"><strong>&quot; target=_blank&gt;极限网络&lt;/a&gt;联系以获取技术支持 <br /> &nbsp;&nbsp;&nbsp;&nbsp; &lt;br&gt;$sql_error&lt;br&gt;&lt;br&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 你也可&lt;a href=\&quot;javascript:window.location=window.location;\&quot;&gt;点此&lt;/a&gt;刷新此页, 若错误仍然存在<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 请正确对待&lt;/body&gt;&lt;/html&gt;&quot;;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo($errorout);<br /> &nbsp;&nbsp; exit;<br /> &nbsp;&nbsp;&nbsp;&nbsp; }<br /> }</strong></font></p> 
<p><font color="#008080" size="3"><strong>if(!$install_tmp) {<br /> $db=new dbclass;<br /> $db-&gt;connect($dbhost,$dbuser,$dbpassword,$pconnect);<br /> $db-&gt;select_db($dbname);<br /> unset($dbhost, $dbuser, $dbpassword, $dbname, $pconnect);<br /> }<br /> ?&gt;<br /> </strong></font></p></div></body></html>