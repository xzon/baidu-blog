<html><head><title><div class="tit">
  进程通信-操作系统设计-C++code
</div></title></head><body><div id='tit'>进程通信-操作系统设计-C++code</div><div id='cate'>代码备份</div><div id='date'>2007年11月19日 星期一 11:56 P.M.</div><div id='page'>207</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/e392193076700d9aa8018e67.html'>http://hi.baidu.com/hxzon/blog/item/e392193076700d9aa8018e67.html</a><div id='cnt'><h1 class="xspace-title">进程通信-操作系统设计-C++code</h1> 
<p>发送进程一行一行地向接收进程发送消息，接收进程把接收到的消息打印出来。当接收进程接收到&quot;end&quot;时,两个进程都结束。此程序中利用套接字进行通信，既可以是同一台计算机内的通信，也可以是不同计算机间的通信。</p> 
<p>发送进程的程序：</p> 
<p class="style1">#include &quot;stdafx.h&quot;<br /> #include &lt;winsock2.h&gt;<br /> #include &lt;stdio.h&gt;<br /> #pragma comment(lib,&quot;ws2_32.lib&quot;) //把ws2_32.lib加到Link页的连接库<br /> #define IP &quot;127.0.0.1&quot; //通信的IP地址<br /> #define PORT 15001 //通信的端口<br /> char buf[2048]; //buf数组是客户端发送的消息</p> 
<p class="style1">void message()<br /> {<br /> &nbsp;&nbsp; printf(&quot;Input the message:&quot;);<br /> &nbsp;&nbsp; int i=0;<br /> &nbsp;&nbsp; memset(buf,0,sizeof(buf));<br /> &nbsp;&nbsp; while((buf<em>=getchar())!='\n') i++;<br /> } </em></p> 
<p class="style1">void send()<br /> {<br /> &nbsp;&nbsp; WSADATA WSAData;<br /> &nbsp;&nbsp; if(WSAStartup(MAKEWORD(2,0),&amp;WSAData)==SOCKET_ERROR){<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Socket initialize fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; return;<br /> &nbsp;&nbsp; }</p> 
<p class="style1">&nbsp;&nbsp; SOCKET sock;<br /> &nbsp;&nbsp; if((sock=socket(AF_INET,SOCK_STREAM,0))==SOCKET_ERROR){<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Socket create fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; WSACleanup();<br /> &nbsp;&nbsp;&nbsp;&nbsp; return;<br /> &nbsp;&nbsp; }<br /> <br /> &nbsp;&nbsp; struct sockaddr_in ClientAddr;<br /> &nbsp;&nbsp; ClientAddr.sin_family=AF_INET;<br /> &nbsp;&nbsp; ClientAddr.sin_port=htons(PORT);<br /> &nbsp;&nbsp; ClientAddr.sin_addr.s_addr=inet_addr(IP);<br /> &nbsp;&nbsp; if(connect(sock,(LPSOCKADDR)&amp;ClientAddr,sizeof(ClientAddr))==SOCKET_ERROR){ //进行服务器连接<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Connect fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; closesocket(sock);<br /> &nbsp;&nbsp;&nbsp;&nbsp; WSACleanup();<br /> &nbsp;&nbsp;&nbsp;&nbsp; return;<br /> &nbsp;&nbsp; }</p> 
<p class="style1">&nbsp;&nbsp; send(sock,buf,2048,0); //向服务器发送数据<br /> &nbsp;&nbsp; closesocket(sock);<br /> &nbsp;&nbsp; WSACleanup();<br /> }</p> 
<p class="style1">void main()<br /> {<br /> &nbsp;&nbsp; for(;;){<br /> &nbsp;&nbsp;&nbsp;&nbsp; message();<br /> &nbsp;&nbsp;&nbsp;&nbsp; send();<br /> &nbsp;&nbsp;&nbsp;&nbsp; if(buf[0]=='e' &amp;&amp; buf[1]=='n' &amp;&amp; buf[2]=='d'){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Program end.\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return; <br /> &nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp; }<br /> }</p> 
<p>接收进程的程序：</p> 
<p class="style1">#include &quot;stdafx.h&quot;<br /> #include &lt;winsock2.h&gt;<br /> #include &lt;windows.h&gt;<br /> #include &lt;stdio.h&gt;<br /> #include &lt;malloc.h&gt;<br /> #pragma comment(lib,&quot;ws2_32.lib&quot;) //把ws2_32.lib加到Link页的连接库<br /> #define IP &quot;127.0.0.1&quot; //通信的IP地址<br /> #define PORT 15001 //通信的端口<br /> #define ERROR 0</p> 
<p class="style1">void main()<br /> {<br /> &nbsp;&nbsp; WSADATA WSAData;<br /> &nbsp;&nbsp; if(WSAStartup(MAKEWORD(2,0),&amp;WSAData)==SOCKET_ERROR){ //启动winsock<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Socket initialize fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; exit(1);<br /> &nbsp;&nbsp; }</p> 
<p class="style1">&nbsp;&nbsp; SOCKET sock;<br /> &nbsp;&nbsp; if((sock=socket(AF_INET,SOCK_STREAM,0))==ERROR){ //建立套接字<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Socket create!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; WSACleanup();<br /> &nbsp;&nbsp;&nbsp;&nbsp; exit(1);<br /> &nbsp;&nbsp; }</p> 
<p class="style1">&nbsp;&nbsp; struct sockaddr_in ServerAddr;<br /> &nbsp;&nbsp; ServerAddr.sin_family=AF_INET;<br /> &nbsp;&nbsp; ServerAddr.sin_port=htons(PORT);<br /> &nbsp;&nbsp; ServerAddr.sin_addr.s_addr=INADDR_ANY;<br /> &nbsp;&nbsp; if(bind(sock,(LPSOCKADDR)&amp;ServerAddr,sizeof(ServerAddr))==SOCKET_ERROR){ //对端口进行监听<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Bind fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; closesocket(sock);<br /> &nbsp;&nbsp;&nbsp;&nbsp; WSACleanup();<br /> &nbsp;&nbsp;&nbsp;&nbsp; exit(1);<br /> &nbsp;&nbsp; }<br /> &nbsp;&nbsp; printf(&quot;Socket port #%d\n&quot;,ntohs(ServerAddr.sin_port));</p> 
<p class="style1">&nbsp;&nbsp; if(listen(sock,10)==SOCKET_ERROR){ //设置最大不被拒绝的请求数<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Listen fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; closesocket(sock);<br /> &nbsp;&nbsp;&nbsp;&nbsp; WSACleanup();<br /> &nbsp;&nbsp;&nbsp;&nbsp; exit(1);<br /> &nbsp;&nbsp; }<br /> <br /> &nbsp;&nbsp; SOCKET msgsock;<br /> &nbsp;&nbsp; char buf[2048];<br /> &nbsp;&nbsp; for(;;){<br /> &nbsp;&nbsp;&nbsp;&nbsp; if((msgsock=accept(sock,(LPSOCKADDR)0,(int *)0))==INVALID_SOCKET){ //接受客户端连接<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Accept fail!\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;<br /> &nbsp;&nbsp;&nbsp;&nbsp; }</p> 
<p class="style1">&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Have client connected.\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp; memset(buf,0,sizeof(buf));<br /> &nbsp;&nbsp;&nbsp;&nbsp; recv(msgsock,buf,2048,0); //接收客户端数据<br /> &nbsp;&nbsp;&nbsp;&nbsp; if(buf[0]=='e' &amp;&amp; buf[1]=='n' &amp;&amp; buf[2]=='d'){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Program end.\n&quot;);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br /> &nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;----&gt;%s&quot;,buf);<br /> &nbsp;&nbsp;&nbsp;&nbsp; closesocket(msgsock);<br /> &nbsp;&nbsp; }<br /> <br /> &nbsp;&nbsp; closesocket(sock); //关闭套接字<br /> &nbsp;&nbsp; WSACleanup(); //关闭winsock<br /> }</p> 
<p>发送进程的输出结果为（红色为键盘输入的数据）：</p> 
<p class="style2">Input the message:<font color="#ff0000"><span class="style3">Hello</span><br /> </font>Input the message:<font color="#ff0000"><span class="style3">This is a text.</span><br /> </font>Input the message:<font color="#ff0000"><span class="style3">end</span><br /> </font>Program end.</p> 
<p>接收进程的输出结果为：</p> 
<p class="style2">Socket port #15001<br /> Have client connected.<br /> ----&gt;Hello<br /> Have client connected.<br /> ----&gt;This is a text.<br /> Have client connected.<br /> Program end.</p> 
<p>(注意：VC中新建<span class="style2"><font color="#0000ff">Win32 Console Application</font></span>程序，Compile(F6)时可能会出现<span class="style2"><font color="#0000ff">fatal error C1083: Cannot open precompiled header file: 'Debug/sen_rec.pch': No such file or directory</font></span>错误，而用Build(F7)可以编译通过。)</p></div></body></html>