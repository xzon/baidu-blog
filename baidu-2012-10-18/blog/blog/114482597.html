<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>TripleDES.java -javacode</title></head><body><h1>TripleDES.java -javacode</h1><div><p> </p>
<p>TripleDES.java -javacode</p>
<p>/*<br>
* Copyright (c) 2000 David Flanagan. All rights reserved.<br>
* This code is from the book Java Examples in a Nutshell, 2nd Edition.<br>
* It is provided AS-IS, WITHOUT ANY WARRANTY either expressed or implied.<br>
* You may study, use, and modify it for any non-commercial purpose.<br>
* You may distribute it non-commercially as long as you retain this notice.<br>
* For a commercial use license, or to purchase the book (recommended),<br>
* visit http://www.davidflanagan.com/javaexamples2.<br>
*/<br>
package com.davidflanagan.examples.security;<br>
import javax.crypto.*;<br>
import javax.crypto.spec.*;<br>
import java.security.*;<br>
import java.security.spec.*;<br>
import java.io.*;</p>
<p>/**<br>
* This class defines methods for encrypting and decrypting using the Triple<br>
* DES algorithm and for generating, reading and writing Triple DES keys.<br>
* It also defines a main() method that allows these methods to be used <br>
* from the command line.<br>
**/<br>
public class TripleDES {<br>
&nbsp;&nbsp;&nbsp;  /**<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * The program. The first argument must be -e, -d, or -g to encrypt,<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * decrypt, or generate a key. The second argument is the name of a file<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * from which the key is read or to which it is written for -g. The<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * -e and -d arguments cause the program to read from standard input and<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * encrypt or decrypt to standard output.<br>
&nbsp;&nbsp;&nbsp;&nbsp;  **/<br>
&nbsp;&nbsp;&nbsp;  public static void main(String[] args) {<br>
try {<br>
&nbsp;&nbsp;&nbsp;&nbsp;  // Check to see whether there is a provider that can do TripleDES<br>
&nbsp;&nbsp;&nbsp;&nbsp;  // encryption. If not, explicitly install the SunJCE provider.<br>
&nbsp;&nbsp;&nbsp;&nbsp;  try { Cipher c = Cipher.getInstance(&quot;DESede&quot;); }<br>
&nbsp;&nbsp;&nbsp;&nbsp;  catch(Exception e) {<br>
&nbsp;&nbsp;  // An exception here probably means the JCE provider hasn't<br>
&nbsp;&nbsp;  // been permanently installed on this system by listing it <br>
&nbsp;&nbsp;  // in the $JAVA_HOME/jre/lib/security/java.security file.<br>
&nbsp;&nbsp;  // Therefore, we have to install the JCE provider explicitly.<br>
&nbsp;&nbsp;  System.err.println(&quot;Installing SunJCE provider.&quot;);<br>
&nbsp;&nbsp;  Provider sunjce = new com.sun.crypto.provider.SunJCE();<br>
&nbsp;&nbsp;  Security.addProvider(sunjce);<br>
&nbsp;&nbsp;&nbsp;&nbsp;  }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;  // This is where we'll read the key from or write it to<br>
&nbsp;&nbsp;&nbsp;&nbsp;  File keyfile = new File(args[1]);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;  // Now check the first arg to see what we're going to do<br>
&nbsp;&nbsp;&nbsp;&nbsp;  if (args[0].equals(&quot;-g&quot;)) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  // Generate a key<br>
&nbsp;&nbsp;  System.out.print(&quot;Generating key. This may take some time...&quot;);<br>
&nbsp;&nbsp;  System.out.flush();<br>
&nbsp;&nbsp;  SecretKey key = generateKey();<br>
&nbsp;&nbsp;  writeKey(key, keyfile);<br>
&nbsp;&nbsp;  System.out.println(&quot;done.&quot;);<br>
&nbsp;&nbsp;  System.out.println(&quot;Secret key written to &quot; + args[1] + <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;. Protect that file carefully!&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;  }<br>
&nbsp;&nbsp;&nbsp;&nbsp;  else if (args[0].equals(&quot;-e&quot;)) { // Encrypt stdin to stdout<br>
&nbsp;&nbsp;  SecretKey key = readKey(keyfile);<br>
&nbsp;&nbsp;  encrypt(key, System.in, System.out);<br>
&nbsp;&nbsp;&nbsp;&nbsp;  }<br>
&nbsp;&nbsp;&nbsp;&nbsp;  else if (args[0].equals(&quot;-d&quot;)) { // Decrypt stdin to stdout<br>
&nbsp;&nbsp;  SecretKey key = readKey(keyfile);<br>
&nbsp;&nbsp;  decrypt(key, System.in, System.out);<br>
&nbsp;&nbsp;&nbsp;&nbsp;  }<br>
}<br>
catch(Exception e) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;  System.err.println(e);<br>
&nbsp;&nbsp;&nbsp;&nbsp;  System.err.println(&quot;Usage: java &quot; + TripleDES.class.getName() +<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot; -d|-e|-g &lt;keyfile&gt;&quot;);<br>
}<br>
&nbsp;&nbsp;&nbsp;  }</p>
<p>&nbsp;&nbsp;&nbsp;  /** Generate a secret TripleDES encryption/decryption key */<br>
&nbsp;&nbsp;&nbsp;  public static SecretKey generateKey() throws NoSuchAlgorithmException {<br>
// Get a key generator for Triple DES (a.k.a DESede)<br>
KeyGenerator keygen = KeyGenerator.getInstance(&quot;DESede&quot;);<br>
// Use it to generate a key<br>
return keygen.generateKey();<br>
&nbsp;&nbsp;&nbsp;  }</p>
<p>&nbsp;&nbsp;&nbsp;  /** Save the specified TripleDES SecretKey to the specified file */<br>
&nbsp;&nbsp;&nbsp;  public static void writeKey(SecretKey key, File f)<br>
throws IOException, NoSuchAlgorithmException, InvalidKeySpecException<br>
&nbsp;&nbsp;&nbsp;  {<br>
// Convert the secret key to an array of bytes like this<br>
SecretKeyFactory keyfactory = SecretKeyFactory.getInstance(&quot;DESede&quot;);<br>
DESedeKeySpec keyspec =<br>
&nbsp;&nbsp;&nbsp;&nbsp;  (DESedeKeySpec)keyfactory.getKeySpec(key, DESedeKeySpec.class);<br>
byte[] rawkey = keyspec.getKey();</p>
<p>// Write the raw key to the file<br>
FileOutputStream out = new FileOutputStream(f);<br>
out.write(rawkey);<br>
out.close();<br>
&nbsp;&nbsp;&nbsp;  }</p>
<p>&nbsp;&nbsp;&nbsp;  /** Read a TripleDES secret key from the specified file */<br>
&nbsp;&nbsp;&nbsp;  public static SecretKey readKey(File f)<br>
throws IOException, NoSuchAlgorithmException,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  InvalidKeyException, InvalidKeySpecException<br>
&nbsp;&nbsp;&nbsp;  {<br>
// Read the raw bytes from the keyfile<br>
DataInputStream in = new DataInputStream(new FileInputStream(f));<br>
byte[] rawkey = new byte[(int)f.length()];<br>
in.readFully(rawkey);<br>
in.close();<br>
<br>
// Convert the raw bytes to a secret key like this<br>
DESedeKeySpec keyspec = new DESedeKeySpec(rawkey);<br>
SecretKeyFactory keyfactory = SecretKeyFactory.getInstance(&quot;DESede&quot;);<br>
SecretKey key = keyfactory.generateSecret(keyspec);<br>
return key;<br>
&nbsp;&nbsp;&nbsp;  }</p>
<p>&nbsp;&nbsp;&nbsp;  /** <br>
&nbsp;&nbsp;&nbsp;&nbsp;  * Use the specified TripleDES key to encrypt bytes from the input stream<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * and write them to the output stream. This method uses <br>
&nbsp;&nbsp;&nbsp;&nbsp;  * CipherOutputStream to perform the encryption and write bytes at the<br>
&nbsp;&nbsp;&nbsp;&nbsp;  * same time.<br>
&nbsp;&nbsp;&nbsp;&nbsp;  **/<br>
&nbsp;&nbsp;&nbsp;  public static void encrypt(SecretKey key, InputStream in, OutputStream out)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  throws NoSuchAlgorithmException, InvalidKeyException,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  NoSuchPaddingException, IOException<br>
&nbsp;&nbsp;&nbsp;  {<br>
// Create and initialize the encryption engine<br>
Cipher cipher = Cipher.getInstance(&quot;DESede&quot;);<br>
cipher.init(Cipher.ENCRYPT_MODE, key);</p>
<p>// Create a special output stream to do the work for us<br>
CipherOutputStream cos = new CipherOutputStream(out, cipher);</p>
<p>// Read from the input and write to the encrypting output stream<br>
byte[] buffer = new byte[2048];<br>
int bytesRead;<br>
while((bytesRead = in.read(buffer)) != -1) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;  cos.write(buffer, 0, bytesRead);<br>
}<br>
cos.close();</p>
<p>// For extra security, don't leave any plaintext hanging around memory.<br>
java.util.Arrays.fill(buffer, (byte) 0);<br>
&nbsp;&nbsp;&nbsp;  }</p>
<p>&nbsp;&nbsp;&nbsp;  /** <br>
&nbsp;&nbsp;&nbsp;&nbsp;  * Use the specified TripleDES key to decrypt bytes ready from the input <br>
&nbsp;&nbsp;&nbsp;&nbsp;  * stream and write them to the output stream. This method uses <br>
&nbsp;&nbsp;&nbsp;&nbsp;  * uses Cipher directly to show how it can be done without <br>
&nbsp;&nbsp;&nbsp;&nbsp;  * CipherInputStream and CipherOutputStream.<br>
&nbsp;&nbsp;&nbsp;&nbsp;  **/<br>
&nbsp;&nbsp;&nbsp;  public static void decrypt(SecretKey key, InputStream in, OutputStream out)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  throws NoSuchAlgorithmException, InvalidKeyException, IOException,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  IllegalBlockSizeException, NoSuchPaddingException,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  BadPaddingException<br>
&nbsp;&nbsp;&nbsp;  {<br>
// Create and initialize the decryption engine<br>
Cipher cipher = Cipher.getInstance(&quot;DESede&quot;);<br>
cipher.init(Cipher.DECRYPT_MODE, key);</p>
<p>// Read bytes, decrypt, and write them out.<br>
byte[] buffer = new byte[2048];<br>
int bytesRead;<br>
while((bytesRead = in.read(buffer)) != -1) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;  out.write(cipher.update(buffer, 0, bytesRead));<br>
}</p>
<p>// Write out the final bunch of decrypted bytes<br>
out.write(cipher.doFinal());<br>
out.flush();<br>
&nbsp;&nbsp;&nbsp;  }<br>
}<br>
164个完整的Java代码\com\davidflanagan\examples\security</p></div></body></html>