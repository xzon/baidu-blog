<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>hxzon_jni_TestJni</title></head><body><h1>hxzon_jni_TestJni</h1><div><p>hxzon_jni_TestJni</p>
<p>/*<br>
* hxzon_jni_TestJni.cpp<br>
*<br>
* Created on: 2009-8-25<br>
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Author: hxzon<br>
*/<br>
#include &lt;jni.h&gt;<br>
#include &quot;hxzon_jni_TestJni.h&quot;<br>
#include &lt;stdio.h&gt;<br>
#include &lt;iostream.h&gt;</p>
<p>jclass Class_java_lang_String;<br>
jclass Class_HObject;<br>
jmethodID MID_String_init;<br>
jmethodID MID_String_getBytes;</p>
<p>void initIDs(JNIEnv *env)<br>
{<br>
//Class_java_lang_String = env-&gt;FindClass(&quot;java/lang/String&quot;);<br>
Class_HObject = env-&gt;FindClass(&quot;hxzon/jni/HObject&quot;);<br>
//MID_String_init = env-&gt;GetMethodID(Class_java_lang_String,<br>
//&nbsp;&nbsp;&nbsp;  &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);<br>
//MID_String_getBytes = env-&gt;GetMethodID(Class_java_lang_String,<br>
//&nbsp;&nbsp;&nbsp;  &quot;getBytes&quot;, &quot;()[B&quot;);<br>
}<br>
/*<br>
* Class:&nbsp;&nbsp;&nbsp;&nbsp;  hxzon_jni_TestJni<br>
* Method:&nbsp;&nbsp;&nbsp;  parse<br>
* Signature: (Ljava/lang/String;)Lhxzon/jni/HObject;<br>
*/<br>
JNIEXPORT jobject JNICALL Java_hxzon_jni_TestJni_parse__Ljava_lang_String_2<br>
(JNIEnv *env, jclass cls, jstring jstr){<br>
initIDs(env);<br>
<br>
jobject ho=env-&gt;AllocObject(Class_HObject);<br>
//str1<br>
jfieldID fid = 0;<br>
fid =env-&gt;GetFieldID(Class_HObject,&quot;str1&quot;,&quot;Ljava/lang/String;&quot;);<br>
env-&gt;SetObjectField(ho,fid, jstr);<br>
//enbytes<br>
fid =env-&gt;GetFieldID(Class_HObject,&quot;enbytes&quot;,&quot;[B&quot;);<br>
jsize len=env-&gt;GetStringUTFLength(jstr);<br>
jbyteArray jbs=env-&gt;NewByteArray(len);</p>
<p>const char *buf=env-&gt;GetStringUTFChars(jstr,0);<br>
char *newbuf=new char[len+1];<br>
for(int i=0;i&lt;len;i++){<br>
newbuf[i]=buf[i]+1;<br>
}<br>
newbuf[len]=0;//must flag end<br>
env-&gt;SetByteArrayRegion(jbs, 0, len, (jbyte *)newbuf);<br>
env-&gt;SetObjectField(ho,fid,jbs);<br>
env-&gt;ReleaseStringUTFChars(jstr,buf);//release<br>
//str2 =newbuf<br>
fid =env-&gt;GetFieldID(Class_HObject,&quot;str2&quot;,&quot;Ljava/lang/String;&quot;);<br>
jstring str2=env-&gt;NewStringUTF(newbuf);<br>
env-&gt;SetObjectField(ho,fid, str2);<br>
return ho;<br>
}<br>
/*<br>
* Class:&nbsp;&nbsp;&nbsp;&nbsp;  hxzon_jni_TestJni<br>
* Method:&nbsp;&nbsp;&nbsp;  parse<br>
* Signature: ([B)Lhxzon/jni/HObject;<br>
*/<br>
JNIEXPORT jobject JNICALL Java_hxzon_jni_TestJni_parse___3B<br>
(JNIEnv *env, jclass cls, jbyteArray encodebytes){<br>
initIDs(env);<br>
<br>
jobject ho=env-&gt;AllocObject(Class_HObject);<br>
//int1<br>
jfieldID fid = NULL;<br>
fid = env-&gt;GetFieldID(Class_HObject, &quot;int1&quot;, &quot;I&quot;);<br>
env-&gt;SetIntField(ho,fid,2);<br>
//str1<br>
fid = env-&gt;GetFieldID(Class_HObject, &quot;str1&quot;, &quot;Ljava/lang/String;&quot;);<br>
jstring str1 = env-&gt;NewStringUTF(&quot;hxzon ,hello str1&quot;);<br>
env-&gt;SetObjectField(ho,fid, str1);<br>
//str2<br>
//fid = env-&gt;GetFieldID(Class_HObject, &quot;str2&quot;, &quot;Ljava/lang/String;&quot;);<br>
//jstring str2 = env-&gt;NewStringUTF(buf);<br>
//env-&gt;SetObjectField(ho,fid, str2);<br>
//enbytes<br>
fid =env-&gt;GetFieldID(Class_HObject,&quot;enbytes&quot;,&quot;[B&quot;);<br>
jsize len=env-&gt;GetArrayLength(encodebytes);<br>
jbyteArray enbytes=env-&gt;NewByteArray(len*2);<br>
char *ch=(char*)env-&gt;GetByteArrayElements(encodebytes,0);<br>
char *newbuf=new char[len*2+1];<br>
for(int i=0,j=0;i&lt;len;i++,j+=2){<br>
&nbsp;&nbsp;  newbuf[j]=(ch[i]&amp;0xf0)&gt;&gt;4;<br>
&nbsp;&nbsp;  newbuf[j+1]=ch[i]&amp;0x0f;<br>
&nbsp;&nbsp;<br>
}<br>
//newbuf[len*2+1]=0;//must flag end<br>
env-&gt;SetByteArrayRegion(enbytes, 0, len*2, (jbyte *)newbuf);<br>
env-&gt;SetObjectField(ho,fid,enbytes);<br>
env-&gt;ReleaseByteArrayElements(encodebytes,(jbyte*)ch,0);//release the get<br>
//get method hexString2bytes<br>
//jmethodID method1 =env-&gt;GetStaticMethodID(env-&gt;FindClass(&quot;hxzon/jni/TestJni&quot;),&quot;method1&quot;,&quot;(Ljava/lang/String;)V&quot;);<br>
//if (method1 == 0) {<br>
&nbsp;&nbsp;&nbsp;  //cout &lt;&lt;&quot;Can't find method method1&quot;;<br>
&nbsp;&nbsp;&nbsp;  //return NULL;<br>
//}</p>
<p>//env-&gt;ExceptionClear();<br>
//env-&gt;CallStaticVoidMethod(env-&gt;FindClass(&quot;hxzon/jni/TestJni&quot;),method1,str1obj); <br>
//if(env-&gt;ExceptionOccurred()) {<br>
// cout &lt;&lt; &quot;error occured copying array back&quot; &lt;&lt;endl;<br>
// env-&gt;ExceptionDescribe();<br>
//&nbsp;&nbsp;  env-&gt;ExceptionClear();<br>
//}</p>
<p><br>
return ho;<br>
}<br>
<br>
//D:\workspace\HxzonUtils\bin&gt;<br>
//cl -I&quot;%java_home%\include&quot; -I&quot;%java_home%\include\win32&quot; -LD hxzon_jni_TestJni.cpp -FetestJni.dll</p></div></body></html>