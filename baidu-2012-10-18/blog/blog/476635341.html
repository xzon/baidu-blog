<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>使用 jQuery、ZK 和 Java 代码的融合来增强 Ajax 开发(节选)</title></head><body><h1>使用 jQuery、ZK 和 Java 代码的融合来增强 Ajax 开发(节选)</h1><div><div><span>使用 jQuery、ZK 和 Java 代码的融合来增强 Ajax 开发(节选)</span><p><em>从服务器端和客户端编程快速获益</em></p><p><a href="http://www.ibm.com/developerworks/cn/web/wa-aj-zkquery/index.html?ca=drs-">http://www.ibm.com/developerworks/cn/web/wa-aj-zkquery/index.html?ca=drs-</a></p><p>&nbsp;</p><p><a href="http://www.ibm.com/developerworks/cn/web/wa-aj-zkquery/index.html?ca=drs-#author1" style="color: #4c6e94;">Lance Lu</a>, 技术推广者, Potix Corp.</p><p><a href="http://www.ibm.com/developerworks/cn/web/wa-aj-zkquery/index.html?ca=drs-#author2" style="color: #4c6e94;">Sachin K Mahajan</a>, 软件开发人员, IBM</p><p><a><strong>图 3. 股票查看应用程序&nbsp;</strong></a><br /><img height="331" src="http://www.ibm.com/developerworks/cn/web/wa-aj-zkquery/stockapp.jpg" width="580" /></p><p><a><span>使用 ZK MVC 的服务器端解决方案（略）</span></a></p><p>&nbsp;</p><p><a><span>服务器和客户端融合解决方案</span></a></p><p>我们来看看使用服务器和客户端融合方法的情况，用同一个样例应用程序。客户端实现最明显的候选者是搜索框，其中响应性是优先考虑的，不单是股票项名称，还有他们对应数据都需要解析和展示。在这种情况下，StockController&nbsp;类不再需要，因为事件处理搜索框只在客户端实现。示例修改 index.zul 并将其重命名为 hybrid.zul。</p><p>hybrid.zul 清单如下所示，注意下列 ZK 指令：</p><p>ZK 的客户端名称空间必须被声明为：<br />&lt;zk xmlns:w=&quot;http://www.zkoss.org/2005/zk/client&quot;&gt;<br />（用于小部件的名称空间 w 是一个 ZK 协议。）</p><p>第 2 行，apply=&quot;StockController&quot;&nbsp;属性是从&nbsp;borderlayout&nbsp;中取出的，因为展示股票名的搜索框和列表框将直接在客户端更新。</p><p>第 8 行，textbox&nbsp;的&nbsp;onChanging&nbsp;事件现在被在客户端使用注解&nbsp;w:&nbsp;声明。</p><p>第 9 行，您可以获取&nbsp;listbox&nbsp;并调用其&nbsp;update()&nbsp;方法。在 Java 中，this.$f(‘list')&nbsp;表达式等于inp.getFellow(&quot;list&quot;)，这可以得到带有&nbsp;id=&quot;list&quot;&nbsp;的&nbsp;listbox&nbsp;控件。</p><p>第 13 行，来自类&nbsp;<a href="http://www.google.com/url?q=http%3A%2F%2Fwww.zkoss.org%2Fjavadoc%2Flatest%2Fjsdoc%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFQzrDfGp8ZS9vK3kCTtZVg_CNQpA" style="color: #4c6e94;">zk.Widget</a>&nbsp;的&nbsp;bind_ callback&nbsp;方法被重写来运行&nbsp;update()&nbsp;方法，在&nbsp;listbox&nbsp;被绑定到 DOM 树之后，设置列表第一项作为选中项。</p><p>第 28 行，zUtl.parseXML()&nbsp;是一个实用程序方法，用于解析 XML 文档。jq()&nbsp;在 ZK 中被用作 jQuery 选择器符号，以至于 jQuery 的&nbsp;$()&nbsp;符号仍然可用。</p><p>第 38 行，使用其标签值和 ID 集合为每个股票项创建一个新的&nbsp;listitem&nbsp;小部件，并附加到&nbsp;listbox&nbsp;上作为它的子部件。</p><p>第 56 至 70 行，listbox&nbsp;的&nbsp;onSelect&nbsp;事件是通过在服务器端为异步请求实现一个服务方法直接进行处理的。该示例为被选中的&nbsp;listitem&nbsp;检索&nbsp;uuid&nbsp;值，并将其附加到 price.zul 页面的请求中，这例展示了股票数据和线性表。</p><p><a><strong>清单 5. hybrid.zul</strong></a></p><p>&nbsp;</p><p><p>1. &lt;zk xmlns:w=&quot;http://www.zkoss.org/2005/zk/client&quot;&gt;</p><p>2. &lt;borderlayout id=&quot;main&quot;&gt;</p><p>3. &nbsp; &nbsp; &nbsp; &nbsp; &lt;west title=&quot;ZK Finance&quot; size=&quot;250px&quot; flex=&quot;true&quot;</p><p>4. &nbsp; &nbsp; &nbsp; &nbsp; splittable=&quot;true&quot; minsize=&quot;210&quot; maxsize=&quot;500&quot; collapsible=&quot;true&quot;&gt;</p><p>5. &nbsp; &nbsp; &nbsp; &nbsp; &lt;panel&gt;</p><p>6. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;panelchildren&gt;</p><p>7. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;textbox id=&quot;inp&quot;&gt;</p><p>8. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;attribute w:name=&quot;onChanging&quot;&gt;</p><p>9. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.$f('list').update(event.data.value);</p><p>10. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/attribute&gt;</p><p>11. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/textbox&gt;</p><p>12. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;listbox id=&quot;list&quot; onSelect=&quot;&quot; rows=&quot;10&quot; width=&quot;300px&quot;&gt;</p><p>13. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;attribute w:name=&quot;bind_&quot;&gt;</p><p>14. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; function (desktop, skipper, after) {</p><p>15. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.$bind_.apply(this, arguments); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>16. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var self = this;</p><p>17. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after.push(function () {</p><p>18. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.update();</p><p>19. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.firstChild.setSelected(true);</p><p>20. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</p><p>21. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>22. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/attribute&gt;</p><p>23. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;attribute w:name=&quot;update&quot;&gt;&lt;![CDATA[</p><p>24.&nbsp;</p><p>25. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (function () {</p><p>26. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var data;</p><p>27. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; function loadData(w) {</p><p>28. &nbsp; &nbsp; &nbsp; &nbsp; var xmlDoc = zk.xml.Utl.parseXML(jq(w).html().replace(/&lt;!--|--&gt;/g,'').trim()),</p><p>29. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ids = xmlDoc.getElementsByTagName(&quot;id&quot;),</p><p>30. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; labels = xmlDoc.getElementsByTagName(&quot;name&quot;);</p><p>31. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = [];</p><p>32. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jq(ids).each(function (i) {</p><p>33. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data.push({id: this.firstChild.nodeValue, label:</p><p>34. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; labels[i].firstChild.nodeValue});</p><p>35. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</p><p>36. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>37.&nbsp;</p><p>38. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; function createItems (listbox, data) {</p><p>39. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!data.length) return;</p><p>40. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jq(data).each(function () {</p><p>41. &nbsp; &nbsp; &nbsp; &nbsp; listbox.appendChild(new zul.sel.Listitem({label: this.label, uuid: this.id}));</p><p>42. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</p><p>43. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>44. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return function (txt) {</p><p>45. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; txt = txt || '';</p><p>46. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!data) loadData(this.$f('data'));</p><p>47. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.clear();</p><p>48. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; createItems(this, jq.grep(data, function (item) {</p><p>49. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return item.label.toLowerCase().indexOf(txt.toLowerCase()) != -1;</p><p>50. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }));</p><p>51. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.stripe();</p><p>52. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; };</p><p>53. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; })()</p><p>54. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]]&gt;&lt;/attribute&gt;</p><p>55. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/listbox&gt;</p><p>56. &nbsp; &nbsp; &nbsp; &nbsp; &lt;zscript&gt;</p><p>57. &nbsp; &nbsp; &nbsp; &nbsp; public class MyService implements org.zkoss.zk.au.AuService {</p><p>58. &nbsp; &nbsp; &nbsp; &nbsp; public boolean service(org.zkoss.zk.au.AuRequest request, boolean everError) {</p><p>59. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; final String cmd = request.getCommand();</p><p>60. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (cmd.equals(Events.ON_SELECT)) {</p><p>61. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String uuid = ((List)request.getData().get(&quot;items&quot;)).get(0);</p><p>62. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.out.println(&quot;selected:&quot; + uuid);</p><p>63. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content.setSrc(&quot;price.zul?id=&quot; + uuid);</p><p>64. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return true;</p><p>65. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>66. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</p><p>67. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>68. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>69. &nbsp; &nbsp; &nbsp; &nbsp; list.setAuService(new MyService());</p><p>70. &lt;/zscript&gt;</p><p>71. &lt;include id=&quot;data&quot; src=&quot;data.xml&quot; comment=&quot;true&quot;/&gt;</p><p>72. &lt;/panelchildren&gt;</p><p>73. &lt;/panel&gt;</p><p>74. &lt;/west&gt;</p><p>75. &lt;center&gt;</p><p>76. &nbsp; &nbsp; &nbsp; &nbsp; &lt;include id=&quot;content&quot; src=&quot;price.zul?id=1&quot;/&gt;</p><p>77. &lt;/center&gt;</p><p>78. &lt;/borderlayout&gt;</p><p>79. &lt;/zk&gt;</p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div><p></p></div></body></html>