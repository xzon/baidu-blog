<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>TCP重组数据包分析</title></head><body><h1>TCP重组数据包分析</h1><div><p>TCP重组数据包分析</p><p><a href="http://blog.csdn.net/simul1981/article/details/3559732">http://blog.csdn.net/simul1981/article/details/3559732</a></p><p><p><span>参照</span><span>TCP/IP</span><span>详解第二卷</span><span>24~29</span><span>章，详细论述了</span><span>TCP</span><span>协议的实现，大概总结一下</span><span>TCP</span><span>如何向应用层保证数据包的正确性、可靠性，即</span><span>TCP</span><span>如何实现对数据报文的重组。</span><span></span></p><p><span>首先要设计两个报文队列，一个存放正常来到的报文，一个存放失序到来的报文。</span><span></span></p><p><span>&nbsp;</span></p><p><span>比如正常报文队列最后一个报文数据如下：</span><span></span></p><p><span>&nbsp;</span></p><p><span>报文数据段第一字节的序号</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>数据报长度</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq1=100</span></p></td><td valign="top"><p><span>len1=100</span></p></td></tr></tbody></table><p><span>&nbsp;</span></p><p><span>下一个来到的报文可能有多种情况，现依次分析如下：</span><span></span></p><p><span>1</span><span>）正常报文</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=200</span></p></td><td valign="top"><p><span>len2=200</span></p></td></tr></tbody></table><p><span>seq2 = seq1+len1</span></p><p><span>由此报文的</span><span>seq</span><span>可知，这个报文携带数据序号</span><span>200~399</span><span>，正是上一个报文的预期后续报文，将此报文追加到正常报文队列。</span><span></span></p><p><span>&nbsp;</span></p><p><span>2</span><span>）完全重复报文</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=100</span></p></td><td valign="top"><p><span>len2=100</span></p></td></tr></tbody></table><p><span>seq2 ==seq1&nbsp;</span><span>而且</span><span>len2==len1</span></p><p><span>这个报文携带数据序号</span><span>100~199</span><span>，与上一个报文携带的数据序号</span><span>100~199</span><span>完全一样，即完全重复，所以应该丢弃这个报文。</span><span></span></p><p><span>&nbsp;</span></p><p><span>3</span><span>）重复子报文</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=100</span></p></td><td valign="top"><p><span>len2=50</span></p></td></tr></tbody></table><p><span>seq2 ==seq1&nbsp;</span><span>而且</span><span>len2&lt;len1</span></p><p><span>这个报文携带数据序号</span><span>100~149</span><span>，说明这是上一个报文的一部分，所以应该丢弃这个报文。</span><span></span></p><p><span>&nbsp;</span></p><p><span>注：第二、三这两种情况可以合并，即</span><span>seq2 ==seq1&nbsp;</span><span>而且</span><span>len2&lt;=len1</span><span>，这里分别列出只是为了说明各种不同情况。</span><span></span></p><p><span>&nbsp;</span></p><p><span>4</span><span>）部分重复报文情况一</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=150</span></p></td><td valign="top"><p><span>len2=30</span></p></td></tr></tbody></table><p><span>seq2&gt;seq1</span><span>而且</span><span>seq2&lt;seq1+len1</span><span>而且</span><span>seq2+len2&lt;=seq1+len1</span></p><p><span>即这个报文携带序号</span><span>150~179</span><span>，这个序号段被包含在上一个报文段中（</span><span>100~199</span><span>），</span><span></span></p><p><span>所以应该丢弃这个报文。</span><span></span></p><p><span>&nbsp;</span></p><p><span>5</span><span>）部分重复报文情况二</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=150</span></p></td><td valign="top"><p><span>len2=100</span></p></td></tr></tbody></table><p><span>seq2&gt;seq1</span><span>而且</span><span>seq2&lt;seq1+len1</span><span>而且</span><span>seq2+len2&gt;seq1+len1</span></p><p><span>即这个报文携带序号</span><span>150~249</span><span>，这个序号段前一部分</span><span>150~199</span><span>被包含在上一个报文段（</span><span>100~199</span><span>）中，后一部分</span><span>200~249</span><span>是新的数据，此时应该对这个报文作如下处理：</span><span></span></p><p><span>A.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span>计算重复字节数</span><span></span></p><p><span>&nbsp;(seq1+len1) - Seq2= 100+100-150 = 50</span></p><p><span>即这个报文段前</span><span>50</span><span>个字节是重复的。</span><span></span></p><p><span>B.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span>截取报文段新数据</span><span></span></p><p><span>丢弃这个报文段的前</span><span>50</span><span>字节，截取后面的新数据，即只保留字节序号段</span><span>200~249</span><span>。</span><span></span></p><p><span>C.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span>重新设置这个报文段的</span><span>seq</span></p><p><span>seq2 = seq2+50 = 150+50 = 200</span></p><p><span>D.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span>重新设置这个报文段的数据长度</span><span></span></p><p><span>len2 = len2-50 =100-50=50</span></p><p><span>E.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span>重新设置后报文段如下</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=200</span></p></td><td valign="top"><p><span>len2=50</span></p></td></tr></tbody></table><p><span>即现在这个报文段携带数据序号</span><span>200~249</span><span>，正好是上一个报文的后续报文，现在可以将其作为正常报文追加到正常报文队列。</span><span></span></p><p><span>&nbsp;</span></p><p><span>6</span><span>）提前到达的报文</span><span></span></p><table cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span>seq2=300</span></p></td><td valign="top"><p><span>len2=100</span></p></td></tr></tbody></table><p><span>seq2&gt;seq1+len1</span></p><p><span>这个报文段携带序号</span><span>300~399</span><span>的数据，即不是上一个报文</span><span>100~199</span><span>的后续报文，而是提前到来的报文，此时应该将这个报文放置到失序报文队列存储起来，以备后续重组使用。</span><span></span></p><p><span>&nbsp;</span></p><p><span>&nbsp;</span></p><p><span>这样直到</span><span>tcp</span><span>断开这个</span><span>socket</span><span>的链接（</span><span>FIN=1</span><span>），此时将正常报文队列和失序报文队列中的数据合并起来，完成重组。取出正常报文队列最后一个报文的</span><span>seq</span><span>和</span><span>len</span><span>，在失序报文队列中查找属于它的后续报文，该报文是否可以作为正常报文队列的后续报文处理过程同前面</span><span>1</span><span>）</span><span>~5</span><span>）的分析。</span></p></p><p></p></div></body></html>